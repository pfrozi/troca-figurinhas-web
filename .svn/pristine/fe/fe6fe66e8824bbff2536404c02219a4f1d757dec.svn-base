using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using TrocaFigurinhas.Models.Persistence;
using System.Data.Objects;

namespace TrocaFigurinhas.Models.Business
{
    public class UsuarioBusiness
    {

        public string login;
        public string Login { get { return login; } set { login = value.ToLower(); } }

        public bool ValidarLogin(string senha)
        {
            bool loginValido;
            using (ModelDBFigurinhasContainer contexto = new ModelDBFigurinhasContainer())
            {
                var usuario = contexto.UsuarioSet.Where(a => a.Login == Login && a.Senha == senha);
                loginValido = (usuario.ToList<Usuario>().Count == 1);
            }
            return (loginValido);

        }

        public Usuario BuscarOfertas()
        {
            Usuario dadosUsuario;
            using (ModelDBFigurinhasContainer contexto = new ModelDBFigurinhasContainer())
            {
                var qUserComOferta = from oferta in contexto.OfertasSet 
                                     join usuario in contexto.UsuarioSet
                                       on oferta.Usuario equals usuario
                                    where oferta.TrocaSolicitante != null

                                     select usuario;

                var qUser = ((ObjectQuery<Usuario>)qUserComOferta)
                    .Include("Ofertas")
                    .Include("Ofertas.TrocaSolicitante")
                    .Include("Ofertas.TrocasSolicitado")
                    .Include("Ofertas.FigurinhasDesejadas")
                    .Include("Ofertas.FigurinhasOfertadas")
                    .Include("Ofertas.FigurinhasDesejadas.Figurinha")
                    .Include("Ofertas.FigurinhasOfertadas.Figurinha")
                    .Include("Ofertas.FigurinhasDesejadas.Figurinha.Album")
                    .Include("Ofertas.FigurinhasOfertadas.Figurinha.Album")
                    .Include("Ofertas.FigurinhasDesejadas.Figurinha.Imagem")
                    .Include("Ofertas.FigurinhasOfertadas.Figurinha.Imagem");
                
                dadosUsuario = qUser.First<Usuario>();
                
            }

            if (dadosUsuario == null)
            {
                throw new BusinessException("Usuário não existe.");
            }

            return dadosUsuario;
        }

        public Usuario BuscarTrocas()
        {
            Usuario dadosUsuario;
            using (ModelDBFigurinhasContainer contexto = new ModelDBFigurinhasContainer())
            {


                //var qUser = ((ObjectQuery<Usuario>)contexto.UsuarioSet.Where(a => a.Login == login))
                //    .Include("Ofertas")

                //    .Include("Ofertas.TrocaSolicitante")
                //    .Include("Ofertas.TrocaSolicitante.OfertaSolicitante")
                //    .Include("Ofertas.TrocaSolicitante.OfertaSolicitante.Usuario")
                //    .Include("Ofertas.TrocaSolicitante.OfertaSolicitante.FigurinhasDesejadas")
                //    .Include("Ofertas.TrocaSolicitante.OfertaSolicitante.FigurinhasOfertadas")
                //    .Include("Ofertas.TrocaSolicitante.OfertaSolicitante.FigurinhasDesejadas.Figurinha")
                //    .Include("Ofertas.TrocaSolicitante.OfertaSolicitante.FigurinhasOfertadas.Figurinha")
                //    .Include("Ofertas.TrocaSolicitante.OfertaSolicitante.FigurinhasDesejadas.Figurinha.Album")
                //    .Include("Ofertas.TrocaSolicitante.OfertaSolicitante.FigurinhasOfertadas.Figurinha.Album")
                //    .Include("Ofertas.TrocaSolicitante.OfertaSolicitante.FigurinhasDesejadas.Figurinha.Imagem")
                //    .Include("Ofertas.TrocaSolicitante.OfertaSolicitante.FigurinhasOfertadas.Figurinha.Imagem")
                //    .Include("Ofertas.TrocaSolicitante.OfertaSolicitado")
                //    .Include("Ofertas.TrocaSolicitante.OfertaSolicitado.Usuario")
                //    .Include("Ofertas.TrocaSolicitante.OfertaSolicitado.FigurinhasDesejadas")
                //    .Include("Ofertas.TrocaSolicitante.OfertaSolicitado.FigurinhasOfertadas")
                //    .Include("Ofertas.TrocaSolicitante.OfertaSolicitado.FigurinhasDesejadas.Figurinha")
                //    .Include("Ofertas.TrocaSolicitante.OfertaSolicitado.FigurinhasOfertadas.Figurinha")
                //    .Include("Ofertas.TrocaSolicitante.OfertaSolicitado.FigurinhasDesejadas.Figurinha.Album")
                //    .Include("Ofertas.TrocaSolicitante.OfertaSolicitado.FigurinhasOfertadas.Figurinha.Album")
                //    .Include("Ofertas.TrocaSolicitante.OfertaSolicitado.FigurinhasDesejadas.Figurinha.Imagem")
                //    .Include("Ofertas.TrocaSolicitante.OfertaSolicitado.FigurinhasOfertadas.Figurinha.Imagem")

                //    .Include("Ofertas.TrocasSolicitado")
                //    .Include("Ofertas.TrocasSolicitado.OfertaSolicitado")
                //    .Include("Ofertas.TrocasSolicitado.OfertaSolicitado.Usuario")
                //    .Include("Ofertas.TrocasSolicitado.OfertaSolicitado.FigurinhasDesejadas")
                //    .Include("Ofertas.TrocasSolicitado.OfertaSolicitado.FigurinhasOfertadas")
                //    .Include("Ofertas.TrocasSolicitado.OfertaSolicitado.FigurinhasDesejadas.Figurinha")
                //    .Include("Ofertas.TrocasSolicitado.OfertaSolicitado.FigurinhasOfertadas.Figurinha")
                //    .Include("Ofertas.TrocasSolicitado.OfertaSolicitado.FigurinhasDesejadas.Figurinha.Album")
                //    .Include("Ofertas.TrocasSolicitado.OfertaSolicitado.FigurinhasOfertadas.Figurinha.Album")
                //    .Include("Ofertas.TrocasSolicitado.OfertaSolicitado.FigurinhasDesejadas.Figurinha.Imagem")
                //    .Include("Ofertas.TrocasSolicitado.OfertaSolicitado.FigurinhasOfertadas.Figurinha.Imagem")
                //    .Include("Ofertas.TrocasSolicitado.OfertaSolicitante")
                //    .Include("Ofertas.TrocasSolicitado.OfertaSolicitante.Usuario")
                //    .Include("Ofertas.TrocasSolicitado.OfertaSolicitante.FigurinhasDesejadas")
                //    .Include("Ofertas.TrocasSolicitado.OfertaSolicitante.FigurinhasOfertadas")
                //    .Include("Ofertas.TrocasSolicitado.OfertaSolicitante.FigurinhasDesejadas.Figurinha")
                //    .Include("Ofertas.TrocasSolicitado.OfertaSolicitante.FigurinhasOfertadas.Figurinha")
                //    .Include("Ofertas.TrocasSolicitado.OfertaSolicitante.FigurinhasDesejadas.Figurinha.Album")
                //    .Include("Ofertas.TrocasSolicitado.OfertaSolicitante.FigurinhasOfertadas.Figurinha.Album")
                //    .Include("Ofertas.TrocasSolicitado.OfertaSolicitante.FigurinhasDesejadas.Figurinha.Imagem")
                //    .Include("Ofertas.TrocasSolicitado.OfertaSolicitante.FigurinhasOfertadas.Figurinha.Imagem")
                //    ;
                //var qUser = contexto.UsuarioSet.Where(a => a.Login == Login);
                var qUser = from usuario in contexto.UsuarioSet
                            join oferta in contexto.OfertasSet
                              on usuario equals oferta.Usuario
                            where usuario.Login.ToLower() == login
                               || oferta.TrocaSolicitante != null
                               || oferta.TrocasSolicitado != null

                            select usuario;

                //qUser = ((ObjectQuery<Usuario>)qUser)
                    //.Include("Ofertas")

                    //.Include("Ofertas.TrocaSolicitante")
                    //.Include("Ofertas.TrocaSolicitante.OfertaSolicitante")
                    //.Include("Ofertas.TrocaSolicitante.OfertaSolicitante.Usuario")
                    //.Include("Ofertas.TrocaSolicitante.OfertaSolicitante.FigurinhasDesejadas")
                    //.Include("Ofertas.TrocaSolicitante.OfertaSolicitante.FigurinhasOfertadas")
                    //.Include("Ofertas.TrocaSolicitante.OfertaSolicitante.FigurinhasDesejadas.Figurinha")
                    //.Include("Ofertas.TrocaSolicitante.OfertaSolicitante.FigurinhasOfertadas.Figurinha")
                    //.Include("Ofertas.TrocaSolicitante.OfertaSolicitante.FigurinhasDesejadas.Figurinha.Album")
                    //.Include("Ofertas.TrocaSolicitante.OfertaSolicitante.FigurinhasOfertadas.Figurinha.Album")
                    //.Include("Ofertas.TrocaSolicitante.OfertaSolicitante.FigurinhasDesejadas.Figurinha.Imagem")
                    //.Include("Ofertas.TrocaSolicitante.OfertaSolicitante.FigurinhasOfertadas.Figurinha.Imagem")
                    //.Include("Ofertas.TrocaSolicitante.OfertaSolicitado")
                    //.Include("Ofertas.TrocaSolicitante.OfertaSolicitado.Usuario")
                    //.Include("Ofertas.TrocaSolicitante.OfertaSolicitado.FigurinhasDesejadas")
                    //.Include("Ofertas.TrocaSolicitante.OfertaSolicitado.FigurinhasOfertadas")
                    //.Include("Ofertas.TrocaSolicitante.OfertaSolicitado.FigurinhasDesejadas.Figurinha")
                    //.Include("Ofertas.TrocaSolicitante.OfertaSolicitado.FigurinhasOfertadas.Figurinha")
                    //.Include("Ofertas.TrocaSolicitante.OfertaSolicitado.FigurinhasDesejadas.Figurinha.Album")
                    //.Include("Ofertas.TrocaSolicitante.OfertaSolicitado.FigurinhasOfertadas.Figurinha.Album")
                    //.Include("Ofertas.TrocaSolicitante.OfertaSolicitado.FigurinhasDesejadas.Figurinha.Imagem")
                    //.Include("Ofertas.TrocaSolicitante.OfertaSolicitado.FigurinhasOfertadas.Figurinha.Imagem")

                    //.Include("Ofertas.TrocasSolicitado")
                    //.Include("Ofertas.TrocasSolicitado.OfertaSolicitado")
                    //.Include("Ofertas.TrocasSolicitado.OfertaSolicitado.Usuario")
                    //.Include("Ofertas.TrocasSolicitado.OfertaSolicitado.FigurinhasDesejadas")
                    //.Include("Ofertas.TrocasSolicitado.OfertaSolicitado.FigurinhasOfertadas")
                    //.Include("Ofertas.TrocasSolicitado.OfertaSolicitado.FigurinhasDesejadas.Figurinha")
                    //.Include("Ofertas.TrocasSolicitado.OfertaSolicitado.FigurinhasOfertadas.Figurinha")
                    //.Include("Ofertas.TrocasSolicitado.OfertaSolicitado.FigurinhasDesejadas.Figurinha.Album")
                    //.Include("Ofertas.TrocasSolicitado.OfertaSolicitado.FigurinhasOfertadas.Figurinha.Album")
                    //.Include("Ofertas.TrocasSolicitado.OfertaSolicitado.FigurinhasDesejadas.Figurinha.Imagem")
                    //.Include("Ofertas.TrocasSolicitado.OfertaSolicitado.FigurinhasOfertadas.Figurinha.Imagem")
                    //.Include("Ofertas.TrocasSolicitado.OfertaSolicitante")
                    //.Include("Ofertas.TrocasSolicitado.OfertaSolicitante.Usuario")
                    //.Include("Ofertas.TrocasSolicitado.OfertaSolicitante.FigurinhasDesejadas")
                    //.Include("Ofertas.TrocasSolicitado.OfertaSolicitante.FigurinhasOfertadas")
                    //.Include("Ofertas.TrocasSolicitado.OfertaSolicitante.FigurinhasDesejadas.Figurinha")
                    //.Include("Ofertas.TrocasSolicitado.OfertaSolicitante.FigurinhasOfertadas.Figurinha")
                    //.Include("Ofertas.TrocasSolicitado.OfertaSolicitante.FigurinhasDesejadas.Figurinha.Album")
                    //.Include("Ofertas.TrocasSolicitado.OfertaSolicitante.FigurinhasOfertadas.Figurinha.Album")
                    //.Include("Ofertas.TrocasSolicitado.OfertaSolicitante.FigurinhasDesejadas.Figurinha.Imagem")
                    //.Include("Ofertas.TrocasSolicitado.OfertaSolicitante.FigurinhasOfertadas.Figurinha.Imagem")
                    //;


                dadosUsuario = qUser.First<Usuario>();

                

                //dadosUsuario.Ofertas.Load();
                //foreach (Ofertas o in dadosUsuario.Ofertas) {
                //    if (o.TrocaSolicitante != null)
                //    {
                //        o.TrocaSolicitante.OfertaSolicitado.FigurinhasDesejadas.Load();
                //        o.TrocaSolicitante.OfertaSolicitado.FigurinhasOfertadas.Load();
                //        o.TrocaSolicitante.OfertaSolicitante.FigurinhasDesejadas.Load();
                //        o.TrocaSolicitante.OfertaSolicitante.FigurinhasOfertadas.Load();
                //    }
                //    if (o.TrocasSolicitado != null)
                //    {
                //        o.TrocasSolicitado.OfertaSolicitado.FigurinhasDesejadas.Load();
                //        o.TrocasSolicitado.OfertaSolicitado.FigurinhasOfertadas.Load();
                //        o.TrocaSolicitante.OfertaSolicitante.FigurinhasDesejadas.Load();
                //        o.TrocaSolicitante.OfertaSolicitante.FigurinhasOfertadas.Load();
                //    }
                //}
            }

            if (dadosUsuario == null)
            {
                throw new BusinessException("Usuário não existe.");
            }

            return dadosUsuario;
        }
    }
}